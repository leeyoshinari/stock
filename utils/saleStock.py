#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Author: leeyoshinari

import asyncio
import json
import traceback
from logging import Logger
from utils.http_client import http


max_retry = 1

sellPrompt = '''
# Role
你是精通 A 股的量化交易专家，性格冷静、果断。你负责对买入后的持仓进行实时监控，根据量价、技术指标与时间锚点，给出唯一的交易执行指令。
# 核心判定规则 (优先级由高到低)
## 第一梯队：强制锁定 (封板/硬止损)
- 涨停保护: 若股价触及涨停（10% 或 20%），无论其他指标如何，必须继续持有。
- 硬性死线: 当前价较持仓成本亏损大于9.5%时，必须立即卖出。
- 技术死刑: 无论盈亏，若出现死叉（MA5/MA10、MACD全部死叉）或价格破布林下轨，立即卖出。
## 第二梯队：量价异动 (关键盘感)
- 放量止损:
 - 09:30 - 10:00  若量比大于10，且股价位于分时均线下方且亏损大于5%，立即卖出。
 - 10:00 - 11:00  若量比大于5，且股价位于分时均线下方且亏损大于5%，立即卖出。
 - 11:00 以后，若量比大于1.5，且股价跌破分时均线且亏损大于6%，立即卖出。
- 高位放量止盈: 盈利大于5%的状态下，若分时出现放量跳水（量比大于1.5且盈利回撤大于3%），立即卖出。
- 跳空截断: 今日开盘价较前日收盘价跌幅大于6%（尤其是前日上涨后），立即卖出。
## 第三梯队：动态止盈与洗盘识别
- 缩量洗盘保护: 若连续 4-5 个交易日价格下跌但成交量萎缩（量比持续下行），视为洗盘，继续持有，直至触及9.5%硬止损。
- 移动止盈: 盈利状态下，日内回撤大于3%触发止盈。若属于“缓慢上涨/缩量上涨”，回撤大于1%且处于盈利状态时，立即卖出；若回撤时处于亏损，则继续持有。
# 执行约束 (防误判指令)
- 回撤定义：使用“当日最高价”计算的回撤，和使用“买入后最高价”计算的回撤，两者取最大回撤值作为判断依据。
- 时间锚点: 你的所有判断必须基于 买入日期 之后的交易数据，严禁将买入前的历史波动作为卖出理由。
- 天级别的数据中，最新日期的所有数据都是截至当前时间实时计算出来的，不一定是一整天的数据。
#  输入的数据
- 当前精确时间。
- 买入日期和持仓成本。
- 最近10日天级数据（含当日实时数据）。每个dict的字段解释: current_price：当日收盘价；last_price：前一日收盘价；open_price：开盘价；max_price：最高价；min_price：最低价；volume：成交量；fund：主力资金净流入（单位：万）；turnover_rate：换手率；ma_five：5日均线；ma_ten：10日均线；ma_twenty：20日均线和布林线中轨线；qrr：量比；diff：MACD的DIFF；dea：MACD的DEA；k：KDJ的K值；d：KDJ的D值；j：KDJ的J值；trix：TRIX指标值；trma：TRIX均线；boll_up：布林线上轨线；boll_low：布林线下轨线。
- 当天分钟实时分时数据。每个dict的字段解释: time：时间，几点几分；price：当前价格；price_avg：当前分时均线价，volume：当前分钟的成交量。
# 标准输出格式
- 返回单个JSON对象，格式是：{{"code":"603128","sell":true,"reason":"分析过程和最终判断结果"}}。如果卖出，sell为true，如果继续持有，sell为false，分析过程和最终判断结果必须包括：交易决策: 卖出/继续持有；核心决策理由；风险预警: (若继续持有，下一个关键压力位或止损位在哪)

【用户输入】
当前时间是: {}，
股票的买入日期是: {}，
持仓成本是: {}，
最近10日天级数据（含当日实时数据）是: {}，
当天分钟实时分时数据是: {}
'''


async def sellAI(api_host: str, model: str, auth_code: str, current_time: str, buyPrice: str, buyDate: str, k_line: str, day_line: str, logger: Logger) -> dict:
    url = f"{api_host}/api/chat"
    header = {"Content-Type": "application/json", "Connection": "keep-alive", "Authorization": f"Bearer {auth_code}"}
    data = {"model": model, "messages": [{"role": "user", "content": sellPrompt.format(current_time, buyDate, buyPrice, k_line, day_line)}]}
    for attempt in range(max_retry):
        try:
            res = await http.post(url=url, json_data=data, headers=header)
            try:
                gemini_res = json.loads(res.text)
                result_text = gemini_res['candidates'][0]['content']['parts'][0]['text']
                res_json = json.loads(result_text.replace('```', '').replace('json', '').replace('\n', ''))
                return res_json
            except:
                logger.error(res.text)
                logger.error(traceback.format_exc())
        except:
            logger.error(traceback.format_exc())
            sleep_time = 2 ** attempt
            await asyncio.sleep(sleep_time)
    raise RuntimeError("Gemini 服务持续繁忙")


'''
你是一个精通中国A股市场的交易员，擅长根据股票走势判断是否买入卖出股票。请根据以下信息判断当前时间是否卖出股票，及时止盈止损，请使用python代码实现判断是否应该卖出？，所有关键阈值要参数化不要使用numpy和pandas等第三方包

提供的参数:
- cost: float, 持有成本
- rise_limit: float, 涨停幅度，例如0.1或0.2
- days_kline: list[dict], 每一天的天级K线数据和技术指标，最近5天的数据，最后一天是当天的实时数据
    每个dict的字段解释: current_price：当日收盘价；last_price：前一日收盘价；open_price：开盘价；max_price：最高价；min_price：最低价；volume：成交量；fund：主力资金净流入（单位：万）；turnover_rate：换手率；ma_five：5日均线；ma_ten：10日均线；ma_twenty：20日均线和布林线中轨线；qrr：量比；diff：MACD的DIFF；dea：MACD的DEA；k：KDJ的K值；d：KDJ的D值；j：KDJ的J值；trix：TRIX指标值；trma：TRIX均线；boll_up：布林线上轨线；boll_low：布林线下轨线
- days_minute_price: list[list[float]], 最近2天的分钟级价格列表，最后一天是当天的部分数据；如果你需要5min中的价格数据，你可以自己计算出来然后使用
- days_minute_volume: list[list[int]], 最近2天的分钟级成交量列表，与days_minute_price对应；如果你需要5min中的成交量数据，你可以自己计算出来然后使用

以下是一些补充说明和交易策略：
1、已知输入的数据是当天截至当前分钟的数据，price和volume都是一个数组，数组最后的数据是最新时间的数据，你只需要判断到当前时间是否应该卖出股票；也有可能不是当天截至当前分钟的所有数据，你需要自己判断并告诉我你需要多长时间的数据；
2、如果股票亏损，那么股票的止损点是10%，不到止损点就继续持有，等待股票上涨；
3、如果股票盈利，那么在股票涨势较好的情况下不需要止盈，继续持有获得更多的收益；如果股票已经盈利，短时间放量下跌回撤，那么当回撤3%时，需要及时止盈，如果回撤后股票处于亏损状态，则不需要止盈或止损，继续持有；
4、股票可以持有很多天，你需要给出一个比较好的方法解决前一天收盘和第二天开盘的数据衔接问题，特别是股票已经上涨后开盘大幅下跌的情况更应该卖出股票；
5、中国A股部分股票涨停是10%，部分股票涨停是20%，如果当天股票涨停，不需要做任何处理，继续持有股票；
6、股票可能开盘直接涨停封板，也可能上下波动慢慢上涨直到涨停，你需要能够处理这种情况，保持持有股票，不能轻易卖出股票；
7、如果股票前几天涨的很好，突然某一天开盘大幅下跌超过3%，你需要及时卖出股票，所以你不能只根据总收益判断，你还需要结合当天的实际行情数据和前一天的收盘价比较；
8、你需要识别出股票是横盘（成交量变化不大）、放量下跌、放量上涨、缓慢下跌、缓慢上涨，如果股票从亏损状态放量上涨，那么继续持有股票；如果股票从亏损状态缓慢上涨，那么在它回撤1%时卖出股票；

对上面的交易策略的优化补充与完善:
1. 原策略基础:
    - 止损: 亏损10%触发。
    - 止盈: 最近10分钟盈利回撤3%。
    - 开盘大幅下跌>3%（尤其是前日上涨后），卖出。
    - 涨停持有。
    - 从亏损放量上涨继续持有；缓慢上涨回撤1%且处于盈利状态时卖出，如果未盈利继续持有。

2. 分钟级精细化:
    - 检测日内放量下跌: 最近10分钟volume > 日均1.5倍 + 价格跌>1%，结合天级信号卖出。
    - 波动率: 如果日内波动>5%且无向上突破，卖出锁定利润。
    - 趋势确认: 使用分钟数据计算短期均线，如果分钟MA5 < MA10 + 天级死叉，强化卖出。

3. 趋势与风险管理:
    - 整体趋势: 如果最近5天close > MA10，继续持有；否则结合其他信号。
    - 累计回撤: 从历史高回撤>5% + 技术指标恶化（MACD死叉或KDJ超买后回落），卖出。
    - 横盘识别: 最近5天价格波动<2% + volume低（<均值0.8倍） + KDJ在40-60，如果小盈利（>2%）卖出。
    - 从亏损恢复: 反弹后若MACD顶背离（价格新高但MACD未新高）或KDJ J>80，卖出。

4. 成交量确认:
    - 放量上涨: volume > 均值1.5倍 + 价格上涨，继续持有。
    - 缩量上涨: 警惕，若已经盈利但回撤>1%卖出，如果回撤>1%但没用盈利，继续持有。
    - 放量下跌: 立即卖出，尤其在支撑位。

5. 多天衔接与异常处理:
    - 开盘衔接: 比较当天open与前日close，处理跳空。
    - 综合评分: 多个信号触发时（>2个卖出信号），强制卖出。

如果还有未考虑的场景，你需要继续补充，让整个交易策略可以获取最大收益，减少亏损。

你是一个精通中国A股市场的交易员，擅长根据股票走势判断是否买入卖出股票。请根据以下信息判断当前时间是否卖出股票，及时止盈止损

提供的参数:
- buy_price: float, 持有成本
- buy_date: str, 买入时间
- days_kline: list[dict], 每一天的天级K线数据和技术指标，最近10天的数据，最后一天是当天的实时数据
    每个dict的字段解释: current_price：当日收盘价；last_price：前一日收盘价；open_price：开盘价；max_price：最高价；min_price：最低价；volume：成交量；fund：主力资金净流入（单位：万）；turnover_rate：换手率；ma_five：5日均线；ma_ten：10日均线；ma_twenty：20日均线和布林线中轨线；qrr：量比；diff：MACD的DIFF；dea：MACD的DEA；k：KDJ的K值；d：KDJ的D值；j：KDJ的J值；trix：TRIX指标值；trma：TRIX均线；boll_up：布林线上轨线；boll_low：布林线下轨线
- minute_datas: list[dict], 当天分钟级实时价格和成交量数据，你可以自行根据数据算出5min/10min中的数据用于辅助判断决策
    每个dict的字段解释: time：时间，几点几分；price：当前价格；volume：当前分钟的成交量；


以下是一些补充说明和交易策略：
1、已知输入的数据是当天截至当前分钟的数据，price和volume都是一个数组，数组最后的数据是最新时间的数据，你只需要判断到当前时间是否应该卖出股票；也有可能不是当天截至当前分钟的所有数据，你需要自己判断并告诉我你需要多长时间的数据；
2、如果股票亏损，那么股票的止损点是10%，不到止损点就继续持有，等待股票上涨；
3、如果股票盈利，那么在股票涨势较好的情况下不需要止盈，继续持有获得更多的收益；如果股票已经盈利，短时间放量下跌回撤，那么当回撤3%时，需要及时止盈，如果回撤后股票处于亏损状态，则不需要止盈或止损，继续持有；
4、股票可以持有很多天，你需要给出一个比较好的方法解决前一天收盘和第二天开盘的数据衔接问题，特别是股票已经上涨后开盘大幅下跌的情况更应该卖出股票；
5、中国A股部分股票涨停是10%，部分股票涨停是20%，如果当天股票涨停，不需要做任何处理，继续持有股票；
6、股票可能开盘直接涨停封板，也可能上下波动慢慢上涨直到涨停，你需要能够处理这种情况，保持持有股票，不能轻易卖出股票；
7、如果股票前几天涨的很好，突然某一天开盘大幅下跌超过3%，你需要及时卖出股票，所以你不能只根据总收益判断，你还需要结合当天的实际行情数据和前一天的收盘价比较；
8、你需要识别出股票是横盘（成交量变化不大）、放量下跌、放量上涨、缓慢下跌、缓慢上涨，如果股票从亏损状态放量上涨，那么继续持有股票；如果股票从亏损状态缓慢上涨，那么在它回撤1%时卖出股票；

对上面的交易策略的优化补充与完善:
1. 原策略基础:
    - 止损: 亏损10%触发。
    - 止盈: 最近10分钟盈利回撤3%。
    - 开盘大幅下跌>3%（尤其是前日上涨后），卖出。
    - 涨停持有。
    - 从亏损放量上涨继续持有；缓慢上涨回撤1%且处于盈利状态时卖出，如果未盈利继续持有。

2. 分钟级精细化:
    - 检测日内放量下跌: 最近10分钟volume > 日均1.5倍 + 价格跌>1%，结合天级信号卖出。
    - 波动率: 如果日内波动>5%且无向上突破，卖出锁定利润。
    - 趋势确认: 使用分钟数据计算短期均线，如果分钟MA5 < MA10 + 天级死叉，强化卖出。
    - 分钟级别的数据，在开盘后的半个小时，成交量会出现异常，导致计算出来的量比偏大，需要合理判断这种场景

3. 趋势与风险管理:
    - 整体趋势: 如果最近5天close > MA10，继续持有；否则结合其他信号。
    - 累计回撤: 从历史高回撤>5% + 技术指标恶化（MACD死叉或KDJ超买后回落），卖出。
    - 横盘识别: 最近5天价格波动<2% + volume低（<均值0.8倍） + KDJ在40-60，如果小盈利（>2%）卖出。
    - 从亏损恢复: 反弹后若MACD顶背离（价格新高但MACD未新高）或KDJ J>80，卖出。

4. 成交量确认:
    - 放量上涨: volume > 均值1.5倍 + 价格上涨，继续持有。
    - 缩量上涨: 警惕，若已经盈利但回撤>1%卖出，如果回撤>1%但没用盈利，继续持有。
    - 放量下跌: 立即卖出，尤其在支撑位。

5. 多天衔接与异常处理:
    - 开盘衔接: 比较当天open与前日close，处理跳空。
    - 综合评分: 多个信号触发时（>2个卖出信号），强制卖出。

如果还有未考虑的场景，你需要继续补充，让整个交易策略可以获取最大收益，减少亏损。

还有以下问题你需要考虑：
1、通常在开盘后的半个小时，成交量会出现异常，导致计算出来的量比偏大，需要合理处理这种场景
2、再加上一个条件：如果股票放量下跌到亏损大于6%，则立即卖出止损，否则在亏损达到9.5%以上时立即卖出止损。同样如果在大幅盈利的情况下也出现放量下跌，那么也要及时卖出止损。
3、如果连续四五个交易日缩量下跌，则继续持有，直到亏损达到9.5%以上时立即卖出止损
4、如果技术面已经严重变坏，无论是否盈利和亏损，都应立即卖出股票

'''
